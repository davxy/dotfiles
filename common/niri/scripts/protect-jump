#!/bin/bash
# Jump to a protected window via fuzzel selection.

PROTECTED_FILE="/tmp/niri-protected-windows"

if [ ! -f "$PROTECTED_FILE" ] || [ ! -s "$PROTECTED_FILE" ]; then
    notify-send -u low "No protected windows"
    exit 0
fi

windows=$(niri msg --json windows)

# Build list: "id | app_id | title"
entries=""
while read -r id; do
    info=$(jq -r --arg id "$id" '.[] | select(.id == ($id | tonumber)) | "\(.id) | \(.app_id) | \(.title)"' <<< "$windows")
    [ -n "$info" ] && entries+="$info"$'\n'
done < "$PROTECTED_FILE"

if [ -z "$entries" ]; then
    notify-send -u low "No protected windows found"
    # Clean up stale file
    rm -f "$PROTECTED_FILE"
    exit 0
fi

chosen=$(printf '%s' "$entries" | fuzzel --dmenu --prompt "Protected > " --width 80)
[ -z "$chosen" ] && exit 0

id=$(cut -d'|' -f1 <<< "$chosen" | tr -d ' ')
niri msg action focus-window --id "$id"
